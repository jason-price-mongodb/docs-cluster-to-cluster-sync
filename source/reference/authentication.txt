.. _c2c-authentication:

=================================================
Authentication Using Workload Identity Federation
=================================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: twocols

.. include:: /includes/mongosync-and-oidc.rst

For details about Atlas Workload Identity Federation and OIDC, see
:atlas:`Atlas Workload Identity Federation </workload-oidc>`.

## Add this later
## For Workforce External Provider software
## requirements, see :ref:`workforce-external-provider`.

Examples
--------

This section shows  ``mongosync``  examples that use Workload Identity
Federation.

In the :ref:`connection string <connections-connection-options>`, set
:urioption:`authMechanism` to ``MONGODB-OIDC`` and set
:urioption:`authMechanismProperties` as needed:

- For Microsoft Azure, set ``authMechanismProperties`` to
  ``ENVIRONMENT:azure``
- For Google Cloud Platform, set ``authMechanismProperties`` to
  ``ENVIRONMENT:gcp``

For more details about:

- connections strings, see :ref:`connection-string-auth-options`
- Authentication in Atlas, see :atlas:`Atlas OIDC Authentication
  </workforce-oidc/#std-label-oidc-authentication-workforce/>`

Connect to MongoDB Clusters Using Microsoft Azure Instance Metadata Service
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following ``mongosync`` example connects to MongoDB clusters using
Microsoft Azure Instance Metadata Service (IMDS):

.. code-block:: shell

   ./bin/mongosync \
         --logPath /var/log/mongosync \
         --cluster0 "mongodb://clusterOne01.fancyCorp.com:20020,clusterOne02.fancyCorp.com:20020,clusterOne03.fancyCorp.com:20020/?authMechanism=MONGODB-OIDC&authMechanismProperties=ENVIRONMENT:azure" \
         --cluster1 "mongodb://clusterTwo01.fancyCorp.com:20020,clusterTwo02.fancyCorp.com:20020,clusterTwo03.fancyCorp.com:20020/?authMechanism=MONGODB-OIDC&authMechanismProperties=ENVIRONMENT:azure"

.. _c2c-authentication-azure-managed-identities-example:

Connect to MongoDB Clusters Using Microsoft Azure Managed Identities
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To connect to MongoDB clusters using Microsoft Azure Managed Identities
and federated authentication, define these environment variables:

.. list-table::
   :header-rows: 1
   :widths: 30 70

   * - Environment Variable
     - Description

   * - ``AZURE_TENANT_ID``
     - Azure tenant identifier.

   * - ``AZURE_APP_CLIENT_ID``
     - Azure application client identifier.

   * - ``AZURE_CLIENT_ID``
     - Azure client identifier.

   * - ``AZURE_FEDERATED_TOKEN_FILE``
     - Azure federated token file's path.

For details about Azure and the variable values, see the Microsoft
Azure documentation.

The following ``mongosync`` example defines the environment variables
and connects to MongoDB clusters in Microsoft Azure:

.. code-block:: shell

   AZURE_TENANT_ID=08206ab8-16a0-406d-85e4-2f15f5620fac \
   AZURE_APP_CLIENT_ID=b6c835da-e536-425b-9405-64bc471e245b \
   AZURE_CLIENT_ID=f176d4eb-7dcd-4f66-bccf-aaa316ee61fd \
   AZURE_FEDERATED_TOKEN_FILE=/var/run/secrets/azure/tokens/azure-identity-token \
   ./bin/mongosync \
         --logPath /var/log/mongosync \
         --cluster0 "mongodb://clusterOne01.fancyCorp.com:20020,clusterOne02.fancyCorp.com:20020,clusterOne03.fancyCorp.com:20020/?authMechanism=MONGODB-OIDC&authMechanismProperties=ENVIRONMENT:azure" \
         --cluster1 "mongodb://clusterTwo01.fancyCorp.com:20020,clusterTwo02.fancyCorp.com:20020,clusterTwo03.fancyCorp.com:20020/?authMechanism=MONGODB-OIDC&authMechanismProperties=ENVIRONMENT:azure"

Connect to MongoDB Clusters in Google Cloud Platform
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following ``mongosync`` example connects to MongoDB clusters in
Google Cloud Platform:

.. code-block:: shell

   ./bin/mongosync \
         --logPath /var/log/mongosync \
         --cluster0 "mongodb://clusterOne01.fancyCorp.com:20020,clusterOne02.fancyCorp.com:20020,clusterOne03.fancyCorp.com:20020/?authMechanism=MONGODB-OIDC&authMechanismProperties=ENVIRONMENT:gcp" \
         --cluster1 "mongodb://clusterTwo01.fancyCorp.com:20020,clusterTwo02.fancyCorp.com:20020,clusterTwo03.fancyCorp.com:20020/?authMechanism=MONGODB-OIDC&authMechanismProperties=ENVIRONMENT:gcp"

No environment variables are required for Google Cloud Platform.

Learn More
----------

- :ref:`c2c-mongosync-behavior`
- :ref:`c2c-connecting`
- :ref:`c2c-states`
- :ref:`c2c-api`
- :ref:`c2c-cutover-process`
